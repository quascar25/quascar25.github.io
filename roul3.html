<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Рулетка 37 секторов</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background-color: rgb(91, 107, 160);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            font-family: Arial, sans-serif;
            overflow: hidden;
            padding-top: 20px;
            perspective: 1000px;
        }
        
        .container {
            width: 90vw;
            height: calc(85.5vh - 19px);
            max-width: calc((85.5vh - 19px) * 9 / 16);
            position: relative;
            transform-origin: top center;
            transform: scaleY(0.95);
        }
        
        .grid {
            width: 100%;
            height: 100%;
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            grid-template-rows: repeat(18, 1fr);
            gap: 0px;
        }
        
        .grid-cell {
            border: 1px solid white;  
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
            font-size: calc(1.2vw + 1.2vh);
        }
        
        .header-cell {
            grid-column: 1 / 6;
            grid-row: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid white;
        }
        
        .balance-text {
            font-size: calc(1.2vw + 1.2vh);
            display: flex;
            align-items: center;
            color: white;
            margin-left: 20px;
        }
        
        .gramophone {
            width: 20px;
            height: 20px;
            cursor: pointer;
            background-color: rgb(91, 107, 160);
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            margin-right: 10px;
        }
        
        .gramophone-icon {
            width: 15px;
            height: 15px;
            background-color: white;
            -webkit-mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z'/%3E%3C/svg%3E") no-repeat center;
            mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z'/%3E%3C/svg%3E") no-repeat center;
        }
        
        .roulette-cell {
            grid-column: 1 / 6;
            grid-row: 2 / 5;
            border: 1px solid white;
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }
        
        #roulette-canvas {
            width: 100%;
            height: 100%;
            display: block;
        }
        
        /* Убираем увеличенный шрифт для 16-го ряда */
        .number-cell {
            grid-row: 17;
            /* font-size: calc(1.5vw + 1.5vh); УДАЛЕНО */
        }
        
        /* Убираем увеличенный шрифт для кнопок */
        .button-cell {
            grid-row: 18;
            cursor: pointer;
            transition: background-color 0.3s;
            /* font-size: calc(1.5vw + 1.5vh); УДАЛЕНО */
        }
        
        .button-cell:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }
        
        .red-cell {
            background-color: #882222;
        }
        
        .black-cell {
            background-color: #222222;
        }
        
        .green-cell {
            background-color: #228822;
        }
        
        .chip-svg {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            transform: scale(0.7);
        }
        
        /* Убираем специальный класс для 17-го ряда */
        /* .row-17-cell {
            font-size: calc(1.5vw + 1.5vh); УДАЛЕНО
        } */
    </style>
</head>
<body>
    <div class="container">
        <div class="grid" id="grid"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // Конфигурация приложения
        const CONFIG = {
            RED_NUMBERS: [1,3,5,7,9,12,14,16,18,19,21,23,25,27,30,32,34,36],
            ROULETTE_NUMBERS: [0,32,15,19,4,21,2,25,17,34,6,27,13,36,11,30,8,23,10,5,24,16,33,1,20,14,31,9,22,18,29,7,28,12,35,3,26],
            SECTOR_VERTICES: [
                [0.871418, 0.000000, -0.148808],
                [0.000077, 0.000000, -0.000028],
                [0.001686, 0.000000, 0.000015],
                [0.884061, 0.000000, 0.000617],
                [80.002892, -2.203763, 0.075245],
                [78.861351, -2.203763, -13.447731],
                [68.994087, -5.824495, -11.810030],
                [69.995773, -5.824494, 0.021153],
                [49.301624, -4.511277, -8.434131],
                [50.020695, -4.511277, 0.021154],
                [39.448170, -2.203763, -6.744274],
                [40.014412, -2.203763, 0.021154],
                [19.723009, 0.000000, -3.360104],
                [20.008930, 0.000000, 0.021154]
            ],
            SECTOR_FACES: [
                [2, 3, 0], [1, 2, 0], [7, 4, 5], [6, 7, 5],
                [8, 9, 7], [7, 6, 8], [10, 11, 9], [9, 8, 10],
                [12, 13, 11], [11, 10, 12], [9, 4, 7], [8, 5, 6]
            ]
        };

        // Состояние приложения
        const AppState = {
            isSpinning: false,
            resultCell: null,
            scene: null,
            camera: null,
            renderer: null,
            rouletteWheel: null,
            audio: null,
            isPlaying: false
        };

        // Инициализация приложения
        document.addEventListener('DOMContentLoaded', function() {
            initializeGrid();
            initializeThreeJS();
            setupEventListeners();
        });

        // Функции для работы с сеткой
        function initializeGrid() {
            const grid = document.getElementById('grid');
            
            // Создаем сетку 5x18
            createGridCells(grid);
            
            // Создаем объединенную ячейку для 0
            createMergedCell(grid);
            
            // Заполняем ячейки числами от 1 до 33
            fillNumberCells();
            
            // Настраиваем специальные ячейки
            setupSpecialCells();
            
            // Создаем верхний заголовок
            createHeader(grid);
            
            // Создаем ряд с числами ставок
            createBetNumbersRow(grid);
            
            // Создаем нижний ряд с кнопками
            createButtonRow(grid);
        }

        function createGridCells(grid) {
            for (let y = 0; y < 18; y++) {
                for (let x = 0; x < 5; x++) {
                    // Пропускаем строки, которые будут заполнены отдельно
                    if (y === 0 || y === 1 || y === 2 || y === 3 || y === 16 || y === 17) continue;

                    const cell = document.createElement('div');
                    cell.className = 'grid-cell';
                    cell.dataset.x = x;
                    cell.dataset.y = y;
                    
                    // Сохраняем ссылку на ячейку результата
                    if (y === 4 && x === 4) {
                        AppState.resultCell = cell;
                        cell.textContent = '-';
                    }
                    
                    grid.appendChild(cell);
                }
            }

            // Удаляем ненужные ячейки в пятом ряду
            removeUnnecessaryCells();
        }

        function removeUnnecessaryCells() {
            const cellsToRemove = [];
            for (let x = 0; x < 5; x++) {
                if (x === 1 || x === 2 || x === 3) {
                    const cell = document.querySelector(`.grid-cell[data-x="${x}"][data-y="4"]`);
                    if (cell) cellsToRemove.push(cell);
                }
            }
            cellsToRemove.forEach(cell => cell.remove());
        }

        function createMergedCell(grid) {
            const mergedCell = document.createElement('div');
            mergedCell.className = 'grid-cell green-cell';
            mergedCell.style.gridColumn = '2 / 5';
            mergedCell.style.gridRow = '5';
            mergedCell.textContent = '0';
            grid.appendChild(mergedCell);
        }

        function fillNumberCells() {
            let currentNumber = 1;
            for (let row = 5; row <= 16; row++) {
                for (let col = 1; col <= 3; col++) {
                    const cell = document.querySelector(`.grid-cell[data-x="${col}"][data-y="${row}"]`);
                    if (cell && currentNumber <= 33) {
                        cell.className += CONFIG.RED_NUMBERS.includes(currentNumber) ? ' red-cell' : ' black-cell';
                        cell.textContent = currentNumber;
                        currentNumber++;
                    }
                }
            }
        }

        function setupSpecialCells() {
            // Настраиваем ячейки с числами в правом столбце
            const specialCells = [
                { x: 4, y: 13, text: '1' },
                { x: 4, y: 14, text: '5' },
                { x: 4, y: 15, text: '25' }
            ];
            
            specialCells.forEach(cellData => {
                const cell = document.querySelector(`.grid-cell[data-x="${cellData.x}"][data-y="${cellData.y}"]`);
                if (cell) {
                    cell.textContent = cellData.text;
                }
            });

            // Очищаем левую ячейку 17 ряда
            const cell17 = document.querySelector('.grid-cell[data-x="0"][data-y="16"]');
            if (cell17) cell17.textContent = '';

            // Создаем фишку в левой ячейке 5 ряда
            createChipCell();
        }

        function createChipCell() {
            const chipCell = document.querySelector('.grid-cell[data-x="0"][data-y="4"]');
            if (chipCell) {
                chipCell.innerHTML = '';
                chipCell.style.position = 'relative';
                chipCell.id = 'chip-origin';
                
                const chipSvg = `
                    <svg class="chip-svg" viewBox="-60 -120 120 120">
                        <path d="M60,0 L60,-10 L20,-10 L10,-20 L10,-56 L16.2,-60 L26.2,-80 L20,-96.8 L0,-106.1 L-20,-96.8 L-26.2,-80 L-16.4,-60 L-10,-56 L-10,-20 L-20,-10 L-60,-10 L-60,0 Z" 
                              fill="yellow" stroke="black" stroke-width="1"/>
                    </svg>
                `;
                chipCell.innerHTML = chipSvg;
                chipCell.style.cursor = 'pointer';
            }
        }

        function createHeader(grid) {
            const headerCell = document.createElement('div');
            headerCell.className = 'header-cell';
            
            const balanceText = document.createElement('div');
            balanceText.className = 'balance-text';
            balanceText.textContent = 'Баланс: 100';
            
            const gramophone = document.createElement('div');
            gramophone.className = 'gramophone';
            gramophone.id = 'gramophone';
            
            const gramophoneIcon = document.createElement('div');
            gramophoneIcon.className = 'gramophone-icon';
            
            gramophone.appendChild(gramophoneIcon);
            headerCell.appendChild(balanceText);
            headerCell.appendChild(gramophone);
            grid.appendChild(headerCell);
            
            // Создаем область рулетки с Three.js
            const rouletteCell = document.createElement('div');
            rouletteCell.className = 'roulette-cell';
            rouletteCell.id = 'roulette-cell';
            grid.appendChild(rouletteCell);
        }

        function createBetNumbersRow(grid) {
            const numbers = ['1', '5', '10', '25', '100'];
            for (let x = 0; x < 5; x++) {
                const numberCell = document.createElement('div');
                numberCell.className = 'grid-cell number-cell';
                numberCell.textContent = numbers[x];
                numberCell.dataset.x = x;
                numberCell.dataset.y = 16;
                grid.appendChild(numberCell);
            }

            // Настраиваем ячейки в 17-ом ряду
            const row17Cells = document.querySelectorAll('.grid-cell[data-y="16"]');
            if (row17Cells.length >= 5) {
                row17Cells[0].textContent = '';
                row17Cells[1].textContent = '34';
                row17Cells[1].className += ' red-cell';
                row17Cells[2].textContent = '35';
                row17Cells[2].className += ' black-cell';
                row17Cells[3].textContent = '36';
                row17Cells[3].className += ' red-cell';
            }
        }

        function createButtonRow(grid) {
            const buttonConfigs = [
                { text: 'Очист', col: 1, action: clearResult },
                { text: '1to2', col: 2, action: resetChipPosition },
                { text: '1to2', col: 3, action: resetChipPosition },
                { text: '1to2', col: 4, action: resetChipPosition },
                { text: 'Дубль', col: 5, action: repeatAction }
            ];
            
            buttonConfigs.forEach(config => {
                const cell = document.createElement('div');
                cell.className = 'grid-cell button-cell';
                cell.style.gridColumn = config.col;
                cell.style.gridRow = '18';
                cell.textContent = config.text;
                cell.addEventListener('click', config.action);
                grid.appendChild(cell);
            });
        }

        // Функции для работы с Three.js
        function initializeThreeJS() {
            const rouletteCell = document.getElementById('roulette-cell');
            
            AppState.scene = new THREE.Scene();
            AppState.scene.background = new THREE.Color(0x5b6ba0);
            
            AppState.camera = new THREE.PerspectiveCamera(45, rouletteCell.clientWidth / rouletteCell.clientHeight, 0.1, 1000);
            AppState.camera.position.set(0, 40, 80);
            AppState.camera.lookAt(0, 0, 0);
            
            AppState.renderer = new THREE.WebGLRenderer({ antialias: true });
            AppState.renderer.setSize(rouletteCell.clientWidth, rouletteCell.clientHeight);
            rouletteCell.appendChild(AppState.renderer.domElement);
            
            setupLighting();
            createRouletteWheel();
            animate();
        }

        function setupLighting() {
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            AppState.scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(30, 50, 30);
            AppState.scene.add(directionalLight);
        }

        function createRouletteWheel() {
            AppState.rouletteWheel = new THREE.Group();
            
            for (let i = 0; i < 37; i++) {
                const sector = createSector(i);
                const angle = (i / 37) * Math.PI * 2;
                sector.rotation.y = angle;
                AppState.rouletteWheel.add(sector);
                addNumberToSector(i, angle);
            }
            
            AppState.rouletteWheel.scale.set(1.5, 1.5, 1.5);
            AppState.rouletteWheel.rotation.x = Math.PI / 6;
            AppState.scene.add(AppState.rouletteWheel);
        }

        function createSector(sectorIndex) {
            const geometry = new THREE.BufferGeometry();
            const vertices = [];
            const indices = [];
            
            CONFIG.SECTOR_VERTICES.forEach(vertex => {
                vertices.push(...vertex);
            });
            
            CONFIG.SECTOR_FACES.forEach(face => {
                indices.push(face[0] - 1, face[1] - 1, face[2] - 1);
            });
            
            geometry.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));
            geometry.setIndex(indices);
            geometry.computeVertexNormals();
            
            const currentNumber = CONFIG.ROULETTE_NUMBERS[sectorIndex];
            let color;
            
            if (currentNumber === 0) {
                color = 0x228822;
            } else if (CONFIG.RED_NUMBERS.includes(currentNumber)) {
                color = 0xaa0000;
            } else {
                color = 0x222222;
            }
            
            const material = new THREE.MeshLambertMaterial({ color: color });
            return new THREE.Mesh(geometry, material);
        }

        function addNumberToSector(sectorIndex, angle) {
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.width = 64;
            canvas.height = 64;
            
            context.fillStyle = 'rgba(0,0,0,0)';
            context.fillRect(0, 0, canvas.width, canvas.height);
            
            context.font = 'bold 48px Arial';
            context.fillStyle = 'white';
            context.textAlign = 'center';
            context.textBaseline = 'middle';
            context.fillText(CONFIG.ROULETTE_NUMBERS[sectorIndex], canvas.width / 2, canvas.height / 2);
            
            const texture = new THREE.CanvasTexture(canvas);
            const material = new THREE.SpriteMaterial({ 
                map: texture,
                transparent: true
            });
            
            const sprite = new THREE.Sprite(material);
            const radius = 70;
            const numberAngle = angle + (Math.PI / 37);
            
            sprite.position.set(
                Math.sin(numberAngle) * radius,
                1,
                Math.cos(numberAngle) * radius
            );
            
            sprite.scale.set(10, 10, 2);
            sprite.rotation.y = -numberAngle;
            AppState.rouletteWheel.add(sprite);
        }

        // Функции для работы с рулеткой
        function spinRoulette() {
            if (AppState.isSpinning) return;
            
            AppState.isSpinning = true;
            const randomRotations = 5 + Math.random() * 5;
            const randomStopAngle = Math.random() * Math.PI * 2;
            const targetRotation = randomRotations * Math.PI * 2 + randomStopAngle;
            
            const startRotation = AppState.rouletteWheel.rotation.y;
            const startTime = Date.now();
            const duration = 4000;
            
            function animateSpin() {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                const easeOut = 1 - Math.pow(1 - progress, 3);
                AppState.rouletteWheel.rotation.y = startRotation + targetRotation * easeOut;
                
                if (progress < 1) {
                    requestAnimationFrame(animateSpin);
                } else {
                    AppState.isSpinning = false;
                    const winningNumber = calculateWinningNumber(randomStopAngle);
                    
                    if (AppState.resultCell) {
                        AppState.resultCell.textContent = winningNumber;
                        AppState.resultCell.style.backgroundColor = 'rgba(255, 255, 255, 0.3)';
                        setTimeout(() => {
                            AppState.resultCell.style.backgroundColor = '';
                        }, 2000);
                    }
                    
                    moveChipToNumber(winningNumber);
                }
            }
            
            animateSpin();
        }

        function calculateWinningNumber(stopAngle) {
            const index = Math.floor((1 - (stopAngle / (Math.PI * 2))) * 37) % 37;
            return CONFIG.ROULETTE_NUMBERS[index];
        }

        function animate() {
            requestAnimationFrame(animate);
            
            if (!AppState.isSpinning) {
                AppState.rouletteWheel.rotation.y += 0.001;
            }
            
            AppState.renderer.render(AppState.scene, AppState.camera);
        }

        // Функции для работы с фишкой
        function resetChipPosition() {
            const chipCell = document.getElementById('chip-origin');
            if (chipCell) {
                chipCell.style.transition = 'all 0.5s ease';
                chipCell.style.transform = 'translate(0, 0)';
            }
        }

        function moveChipToNumber(number) {
            const chipCell = document.getElementById('chip-origin');
            if (!chipCell) return;
            
            let targetCell = null;
            for (let row = 5; row <= 17; row++) {
                for (let col = 0; col < 5; col++) {
                    const cell = document.querySelector(`.grid-cell[data-x="${col}"][data-y="${row}"]`);
                    if (cell && cell.textContent === number.toString() && cell.id !== 'chip-origin') {
                        targetCell = cell;
                        break;
                    }
                }
                if (targetCell) break;
            }
            
            if (targetCell) {
                const chipRect = chipCell.getBoundingClientRect();
                const targetRect = targetCell.getBoundingClientRect();
                
                chipCell.style.transition = 'all 0.5s ease';
                chipCell.style.transform = `translate(${targetRect.left - chipRect.left}px, ${targetRect.top - chipRect.top + 5}px)`;
                
                setTimeout(() => {
                    chipCell.style.transition = 'all 0.5s ease';
                    chipCell.style.transform = 'translate(0, 0)';
                }, 2000);
            }
        }

        // Обработчики событий
        function setupEventListeners() {
            // Обработчик клика на любую ячейку
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('grid-cell') && !e.target.id.includes('chip')) {
                    resetChipPosition();
                }
            });
            
            // Обработчик для грамофончика
            const gramophone = document.getElementById('gramophone');
            gramophone.addEventListener('click', toggleAudio);
            
            // Обработчик для рулетки
            AppState.renderer.domElement.addEventListener('click', spinRoulette);
            
            // Обработчик изменения размера окна
            window.addEventListener('resize', handleResize);
        }

        function toggleAudio() {
            if (!AppState.isPlaying) {
                try {
                    AppState.audio = new Audio('audio/space-music.mp3');
                    AppState.audio.play().catch(e => {
                        alert('Файл audio/space-music.mp3 не найден');
                    });
                    AppState.isPlaying = true;
                } catch (error) {
                    alert('Не удалось воспроизвести аудиофайл');
                }
            } else {
                if (AppState.audio) {
                    AppState.audio.pause();
                    AppState.audio.currentTime = 0;
                }
                AppState.isPlaying = false;
            }
        }

        function handleResize() {
            const rouletteCell = document.getElementById('roulette-cell');
            AppState.camera.aspect = rouletteCell.clientWidth / rouletteCell.clientHeight;
            AppState.camera.updateProjectionMatrix();
            AppState.renderer.setSize(rouletteCell.clientWidth, rouletteCell.clientHeight);
        }

        // Вспомогательные функции
        function clearResult() {
            if (AppState.resultCell) AppState.resultCell.textContent = '-';
            resetChipPosition();
        }

        function repeatAction() {
            alert('Функция "Повторить" активирована');
            resetChipPosition();
        }
    </script>
</body>
</html>
