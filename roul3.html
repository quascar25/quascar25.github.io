<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Рулетка 37 секторов</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background-color: rgb(91, 107, 160);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            font-family: Arial, sans-serif;
            overflow: hidden;
            padding-top: 20px;
            perspective: 1000px;
        }
        
        .container {
            width: 90vw;
            height: calc(85.5vh - 19px);
            max-width: calc((85.5vh - 19px) * 9 / 16);
            position: relative;
            transform-origin: top center;
            transform: scaleY(0.95);
        }
        
        .grid {
            width: 100%;
            height: 100%;
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            grid-template-rows: repeat(18, 1fr);
            gap: 1px;
        }
        
        .grid-cell {
            border: 1px solid white;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
            font-size: calc(1.2vw + 1.2vh);
        }
        
        .header-cell {
            grid-column: 1 / 6;
            grid-row: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid white;
        }
        
        .balance-text {
            font-size: calc(1.2vw + 1.2vh);
            display: flex;
            align-items: center;
            color: white;
            margin-left: 20px;
        }
        
        .gramophone {
            width: 20px;
            height: 20px;
            cursor: pointer;
            background-color: rgb(91, 107, 160);
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            margin-right: 10px;
        }
        
        .gramophone-icon {
            width: 15px;
            height: 15px;
            background-color: white;
            -webkit-mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z'/%3E%3C/svg%3E") no-repeat center;
            mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z'/%3E%3C/svg%3E") no-repeat center;
        }
        
        .roulette-cell {
            grid-column: 1 / 6;
            grid-row: 2 / 5;
            border: 1px solid white;
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }
        
        #roulette-canvas {
            width: 100%;
            height: 100%;
            display: block;
        }
        
        .number-cell {
            grid-row: 17;
            font-size: calc(1.5vw + 1.5vh);
        }
        
        .button-cell {
            grid-row: 18;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .button-cell:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }
        
        .clear-btn {
            grid-column: 1 / 3;
        }
        
        .repeat-btn {
            grid-column: 4 / 6;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="grid" id="grid">
            <!-- Сетка создается с помощью JavaScript -->
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        let scene, camera, renderer, rouletteWheel;
        let isSpinning = false;
        let resultCell = null;
        
        // Данные сектора из OBJ файла
        const sectorVertices = [
            [0.871418, 0.000000, -0.148808],
            [0.000077, 0.000000, -0.000028],
            [0.001686, 0.000000, 0.000015],
            [0.884061, 0.000000, 0.000617],
            [80.002892, -2.203763, 0.075245],
            [78.861351, -2.203763, -13.447731],
            [68.994087, -5.824495, -11.810030],
            [69.995773, -5.824494, 0.021153],
            [49.301624, -4.511277, -8.434131],
            [50.020695, -4.511277, 0.021154],
            [39.448170, -2.203763, -6.744274],
            [40.014412, -2.203763, 0.021154],
            [19.723009, 0.000000, -3.360104],
            [20.008930, 0.000000, 0.021154]
        ];
        
        const sectorFaces = [
            [2, 3, 0], [1, 2, 0], [7, 4, 5], [6, 7, 5],
            [8, 9, 7], [7, 6, 8], [10, 11, 9], [9, 8, 10],
            [12, 13, 11], [11, 10, 12], [9, 4, 7], [8, 5, 6]
        ];

        // Числа рулетки в стандартном порядке
        const rouletteNumbers = [0,32,15,19,4,21,2,25,17,34,6,27,13,36,11,30,8,23,10,5,24,16,33,1,20,14,31,9,22,18,29,7,28,12,35,3,26];

        document.addEventListener('DOMContentLoaded', function() {
            const grid = document.getElementById('grid');
            
            // Создаем сетку 5x18
            for (let y = 0; y < 18; y++) {
                for (let x = 0; x < 5; x++) {
                    if (y === 0 || y === 1 || y === 2 || y === 3 || y === 16 || y === 17) continue;
                    
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell';
                    cell.dataset.x = x;
                    cell.dataset.y = y;
                    
                    // Сохраняем ссылку на ячейку в пятом ряду, правом столбце (x=4, y=4)
                    if (y === 4 && x === 4) {
                        resultCell = cell;
                        cell.textContent = '-';
                    }
                    
                    grid.appendChild(cell);
                }
            }
            
            // Создаем объединенный верхний прямоугольник
            const headerCell = document.createElement('div');
            headerCell.className = 'header-cell';
            
            const balanceText = document.createElement('div');
            balanceText.className = 'balance-text';
            balanceText.textContent = 'Баланс: 100';
            
            const gramophone = document.createElement('div');
            gramophone.className = 'gramophone';
            gramophone.id = 'gramophone';
            
            const gramophoneIcon = document.createElement('div');
            gramophoneIcon.className = 'gramophone-icon';
            
            gramophone.appendChild(gramophoneIcon);
            headerCell.appendChild(balanceText);
            headerCell.appendChild(gramophone);
            grid.appendChild(headerCell);
            
            // Создаем область рулетки с Three.js
            const rouletteCell = document.createElement('div');
            rouletteCell.className = 'roulette-cell';
            rouletteCell.id = 'roulette-cell';
            
            grid.appendChild(rouletteCell);
            
            // Инициализируем Three.js сцену
            initThreeJS();
            
            // Создаем предпоследний ряд с числами
            const numbers = ['1', '5', '10', '25', '100'];
            for (let x = 0; x < 5; x++) {
                const numberCell = document.createElement('div');
                numberCell.className = 'grid-cell number-cell';
                numberCell.textContent = numbers[x];
                numberCell.dataset.x = x;
                numberCell.dataset.y = 16;
                grid.appendChild(numberCell);
            }
            
            // Создаем нижний ряд с кнопками
            const clearBtn = document.createElement('div');
            clearBtn.className = 'grid-cell button-cell clear-btn';
            clearBtn.textContent = 'Очистить';
            clearBtn.dataset.x = 0;
            clearBtn.dataset.y = 17;
            
            const repeatBtn = document.createElement('div');
            repeatBtn.className = 'grid-cell button-cell repeat-btn';
            repeatBtn.textContent = 'Повторить';
            repeatBtn.dataset.x = 3;
            repeatBtn.dataset.y = 17;
            
            grid.appendChild(clearBtn);
            grid.appendChild(repeatBtn);
            
            // Обработчик для грамофончика
            let isPlaying = false;
            let audio = null;
            
            gramophone.addEventListener('click', function() {
                if (!isPlaying) {
                    try {
                        audio = new Audio('audio/space-music.mp3');
                        audio.play().catch(e => {
                            console.log('Ошибка воспроизведения:', e);
                            alert('Файл audio/space-music.mp3 не найден или не может быть воспроизведен');
                        });
                        isPlaying = true;
                        gramophone.style.backgroundColor = 'rgb(91, 107, 160)';
                    } catch (error) {
                        console.log('Ошибка:', error);
                        alert('Не удалось воспроизвести аудиофайл');
                    }
                } else {
                    if (audio) {
                        audio.pause();
                        audio.currentTime = 0;
                    }
                    isPlaying = false;
                    gramophone.style.backgroundColor = 'rgb(91, 107, 160)';
                }
            });
            
            // Обработчики для кнопок
            clearBtn.addEventListener('click', function() {
                if (resultCell) {
                    resultCell.textContent = '-';
                }
                alert('Функция "Очистить" активирована');
            });
            
            repeatBtn.addEventListener('click', function() {
                alert('Функция "Повторить" активирована');
            });
        });

        function initThreeJS() {
            const rouletteCell = document.getElementById('roulette-cell');
            
            // Сцена
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x5b6ba0);
            
            // Камера - настраиваем под размер контейнера
            camera = new THREE.PerspectiveCamera(45, rouletteCell.clientWidth / rouletteCell.clientHeight, 0.1, 1000);
            camera.position.set(0, 40, 80);
            camera.lookAt(0, 0, 0);
            
            // Рендерер
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(rouletteCell.clientWidth, rouletteCell.clientHeight);
            rouletteCell.appendChild(renderer.domElement);
            
            // Освещение
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(30, 50, 30);
            scene.add(directionalLight);
            
            // Создаем рулетку
            createRouletteWheel();
            
            // Обработчик клика на рулетку
            renderer.domElement.addEventListener('click', spinRoulette);
            
            // Анимация
            animate();
        }
        
        function createRouletteWheel() {
            rouletteWheel = new THREE.Group();
            
            // Создаем 37 секторов
            for (let i = 0; i < 37; i++) {
                const sector = createSector(i);
                const angle = (i / 37) * Math.PI * 2;
                sector.rotation.y = angle;
                rouletteWheel.add(sector);
                
                // Добавляем число на сектор
                addNumberToSector(i, angle);
            }
            
            // Масштабируем рулетку чтобы вписать в контейнер
            rouletteWheel.scale.set(1.5, 1.5, 1.5);
            rouletteWheel.rotation.x = Math.PI / 6;
            
            scene.add(rouletteWheel);
        }
        
        function createSector(sectorIndex) {
            const geometry = new THREE.BufferGeometry();
            const vertices = [];
            const indices = [];
            
            // Создаем вершины для сектора
            sectorVertices.forEach(vertex => {
                vertices.push(...vertex);
            });
            
            // Создаем индексы для треугольников
            sectorFaces.forEach(face => {
                indices.push(face[0] - 1, face[1] - 1, face[2] - 1);
            });
            
            geometry.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));
            geometry.setIndex(indices);
            geometry.computeVertexNormals();
            
            // Цвета секторов (европейская рулетка)
            let color;
            // if (sectorIndex === 0) {
            //     color = 0x00ff00; // Зеленый для 0
            // } else {
            //     color = (sectorIndex % 2 === 1) ? 0xff0000 : 0x000000; // Чередование красный/черный
            // }

                        // Альтернативные цвета:
            if (sectorIndex === 0) {
                color = 0x228822; // Темно-зеленый
            } else {
                color = (sectorIndex % 2 === 1) ? 0xaa0000 : 0x222222; // Темно-красный / Темно-серый
            }
            
            const material = new THREE.MeshLambertMaterial({ color: color });
            const mesh = new THREE.Mesh(geometry, material);
            
            return mesh;
        }
        
        function addNumberToSector(sectorIndex, angle) {
            // Создаем canvas для текста
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.width = 64;
            canvas.height = 64;
            
            // Очищаем canvas
            context.fillStyle = 'rgba(0,0,0,0)';
            context.fillRect(0, 0, canvas.width, canvas.height);
            
            // Рисуем текст
            context.font = 'bold 48px Arial';
            context.fillStyle = 'white';
            context.textAlign = 'center';
            context.textBaseline = 'middle';
            context.fillText(rouletteNumbers[sectorIndex], canvas.width / 2, canvas.height / 2);
            
            // Создаем текстуру из canvas
            const texture = new THREE.CanvasTexture(canvas);
            const material = new THREE.SpriteMaterial({ 
                map: texture,
                transparent: true
            });
            
            const sprite = new THREE.Sprite(material);
            
            // Позиционируем число на секторе
            //const radius = 35; // Радиус от центра
            const radius = 70; // Радиус от центра
            const numberAngle = angle + (Math.PI / 37); // Смещаем к центру сектора
            
            sprite.position.set(
                Math.sin(numberAngle) * radius,
                1, // Немного выше поверхности
                Math.cos(numberAngle) * radius
            );
            
            // Масштабируем до размера ~5 пикселей
            //sprite.scale.set(8, 8, 1);
            // Масштабируем до размера ~50 пикселей
            sprite.scale.set(10,10, 2);   
            // Поворачиваем число к камере
            sprite.rotation.y = -numberAngle;
            
            rouletteWheel.add(sprite);
        }
        
        function spinRoulette() {
            if (isSpinning) return;
            
            isSpinning = true;
            const randomRotations = 5 + Math.random() * 5;
            const randomStopAngle = Math.random() * Math.PI * 2;
            const targetRotation = randomRotations * Math.PI * 2 + randomStopAngle;
            
            const startRotation = rouletteWheel.rotation.y;
            const startTime = Date.now();
            const duration = 4000;
            
            function animateSpin() {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                // Плавное замедление
                const easeOut = 1 - Math.pow(1 - progress, 3);
                rouletteWheel.rotation.y = startRotation + targetRotation * easeOut;
                
                if (progress < 1) {
                    requestAnimationFrame(animateSpin);
                } else {
                    isSpinning = false;
                    // Определяем выигрышное число
                    const winningNumber = calculateWinningNumber(randomStopAngle);
                    
                    // Отображаем результат в ячейке
                    if (resultCell) {
                        resultCell.textContent = winningNumber;
                        resultCell.style.backgroundColor = 'rgba(255, 255, 255, 0.3)';
                        setTimeout(() => {
                            resultCell.style.backgroundColor = '';
                        }, 2000);
                    }
                }
            }
            
            animateSpin();
        }
        
        function calculateWinningNumber(stopAngle) {
            const index = Math.floor((1 - (stopAngle / (Math.PI * 2))) * 37) % 37;
            return rouletteNumbers[index];
        }
        
        function animate() {
            requestAnimationFrame(animate);
            
            if (!isSpinning) {
                // Медленное вращение в покое
                rouletteWheel.rotation.y += 0.001;
            }
            
            renderer.render(scene, camera);
        }
        
        // Обработчик изменения размера окна
        window.addEventListener('resize', function() {
            const rouletteCell = document.getElementById('roulette-cell');
            camera.aspect = rouletteCell.clientWidth / rouletteCell.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(rouletteCell.clientWidth, rouletteCell.clientHeight);
        });
    </script>
</body>
</html>
