<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cosmic Connections - –ó–Ω–∞–∫–æ–º—Å—Ç–≤–∞</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="stars"></div>
    <div id="stars2"></div>
    <div id="stars3"></div>
    <div class="starships">
        <div class="starship" id="starship1">‚éà</div>
        <div class="starship" id="starship2">‚éà</div>
        <div class="starship" id="starship3">‚éà</div>
    </div>

    <div class="container">
        <!-- –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
        <div class="profile-section">
            <div class="profile-header">
                <h1>üåå Cosmic Connections</h1>
                <div class="user-profile">
                    <div class="avatar-container">
                        <img id="userAvatar" src="" alt="–í–∞—à –∞–≤–∞—Ç–∞—Ä" class="avatar">
                        <input type="file" id="avatarUpload" accept="image/*" multiple style="display: none;">
                        <button onclick="document.getElementById('avatarUpload').click()" class="upload-btn">
                            üì∑ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ (–º–∞–∫—Å. 5)
                        </button>
                    </div>
                    <div class="photo-preview" id="photoPreview"></div>
                </div>
            </div>
        </div>

        <!-- –ß–∞—Ç -->
        <div class="chat-section">
            <div class="chat-header">
                <h2>üí´ –ì–∞–ª–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —á–∞—Ç</h2>
                <div class="online-count">üë• –û–Ω–ª–∞–π–Ω: <span id="onlineCount">1</span></div>
            </div>
            
            <div class="chat-messages" id="chatMessages">
                <div class="system-message">
                    üåü –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –∫–æ—Å–º–∏—á–µ—Å–∫–∏–π —á–∞—Ç! –í—ã –≤–∏–¥–∏—Ç–µ –≤—Å–µ—Ö, –¥—Ä—É–≥–∏–µ –≤–∏–¥—è—Ç —Ç–æ–ª—å–∫–æ –≤–∞—Å.
                </div>
            </div>

            <div class="chat-input-container">
                <div class="emoji-picker">
                    <button onclick="toggleEmojiPicker()">üòä</button>
                    <div class="emoji-grid" id="emojiGrid">
                        <span onclick="addEmoji('üòä')">üòä</span>
                        <span onclick="addEmoji('üòÇ')">üòÇ</span>
                        <span onclick="addEmoji('‚ù§Ô∏è')">‚ù§Ô∏è</span>
                        <span onclick="addEmoji('üëç')">üëç</span>
                        <span onclick="addEmoji('üéâ')">üéâ</span>
                        <span onclick="addEmoji('üåü')">üåü</span>
                        <span onclick="addEmoji('üöÄ')">üöÄ</span>
                        <span onclick="addEmoji('üí´')">üí´</span>
                        <span onclick="addEmoji('üëã')">üëã</span>
                        <span onclick="addEmoji('üòç')">üòç</span>
                        <span onclick="addEmoji('üòé')">üòé</span>
                        <span onclick="addEmoji('ü§î')">ü§î</span>
                        <span onclick="addEmoji('üéà')">üéà</span>
                        <span onclick="addEmoji('üì∏')">üì∏</span>
                        <span onclick="addEmoji('üåô')">üåô</span>
                        <span onclick="addEmoji('‚òÄÔ∏è')">‚òÄÔ∏è</span>
                    </div>
                </div>
                <input type="text" id="messageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." maxlength="500">
                <button onclick="sendMessage()" class="send-btn">üì§</button>
            </div>
        </div>

        <!-- –£—á–∞—Å—Ç–Ω–∏–∫–∏ —á–∞—Ç–∞ -->
        <div class="participants-section">
            <h3>üëΩ –£—á–∞—Å—Ç–Ω–∏–∫–∏ —á–∞—Ç–∞</h3>
            <div class="participants-list" id="participantsList">
                <div class="participant you">
                    <div class="participant-avatar">üë§</div>
                    <div class="participant-info">
                        <div class="participant-name">–í—ã</div>
                        <div class="participant-status online">online</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    
    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyChVNJexhWHuV9KCv52VssFA1MvYaRulBk",
            authDomain: "jetchat-481ee.firebaseapp.com",
            databaseURL: "https://jetchat-481ee-default-rtdb.firebaseio.com",
            projectId: "jetchat-481ee",
            storageBucket: "jetchat-481ee.firebasestorage.app",
            messagingSenderId: "180249150993",
            appId: "1:180249150993:web:eaeb4ed6165f6f16fe53b0",
            measurementId: "G-75MCW0R6ED"
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // –°—Å—ã–ª–∫–∏ –Ω–∞ —Ä–∞–∑–¥–µ–ª—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
        const messagesRef = database.ref('messages');
        const usersRef = database.ref('users');

        class DatingChat {
            constructor() {
                this.userPhotos = [];
                this.participants = new Map();
                this.chatMessages = [];
                this.emojiPickerVisible = false;
                this.userId = 'user_' + Math.random().toString(36).substr(2, 9);
                this.userName = '–ê–Ω–æ–Ω–∏–º';
                
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.loadAllData();
                this.createStars();
                this.setupFirebaseListeners();
                this.simulateOtherUsers();
            }

            setupEventListeners() {
                // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π
                document.getElementById('avatarUpload').addEventListener('change', (e) => {
                    this.handlePhotoUpload(e.target.files);
                });

                // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ Enter
                document.getElementById('messageInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.sendMessage();
                    }
                });

                // –ó–∞–∫—Ä—ã—Ç–∏–µ —ç–º–æ–¥–∑–∏-–ø–∏–∫–µ—Ä–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.emoji-picker')) {
                        this.hideEmojiPicker();
                    }
                });
            }

            setupFirebaseListeners() {
                // –°–ª—É—à–∞–µ–º –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ Firebase
                messagesRef.limitToLast(50).on('value', (snapshot) => {
                    const messages = snapshot.val();
                    this.displayMessagesFromFirebase(messages);
                });
            }

            displayMessagesFromFirebase(messages) {
                const messagesContainer = document.getElementById('chatMessages');
                
                if (!messages) return;
                
                // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –æ–±—ä–µ–∫—Ç –≤ –º–∞—Å—Å–∏–≤ –∏ —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏
                const messagesArray = Object.entries(messages).map(([key, value]) => ({
                    id: key,
                    ...value
                })).sort((a, b) => a.timestamp - b.timestamp);

                // –û—á–∏—â–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
                if (this.chatMessages.length === 0) {
                    messagesContainer.innerHTML = '<div class="system-message">üåü –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –∫–æ—Å–º–∏—á–µ—Å–∫–∏–π —á–∞—Ç! –°–æ–æ–±—â–µ–Ω–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏.</div>';
                }

                // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                messagesArray.forEach(msg => {
                    if (!this.chatMessages.find(m => m.id === msg.id)) {
                        this.addMessageToUI(msg.senderName, msg.text, msg.senderId === this.userId ? 'user' : 'other');
                        this.chatMessages.push(msg);
                    }
                });

                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            sendMessage() {
                const input = document.getElementById('messageInput');
                const message = input.value.trim();

                if (message) {
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Firebase
                    const messageData = {
                        senderId: this.userId,
                        senderName: this.userName,
                        text: message,
                        timestamp: Date.now()
                    };
                    
                    messagesRef.push(messageData)
                        .then(() => {
                            console.log('‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Firebase!');
                            input.value = '';
                        })
                        .catch(error => {
                            console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', error);
                        });
                }
            }

            addMessageToUI(sender, text, type) {
                const messagesContainer = document.getElementById('chatMessages');
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${type}`;

                const now = new Date();
                const timeString = now.toLocaleTimeString('ru-RU', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });

                messageDiv.innerHTML = `
                    <div class="message-header">${sender} ‚Ä¢ ${timeString}</div>
                    <div class="message-text">${this.formatMessage(text)}</div>
                `;

                messagesContainer.appendChild(messageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                
                messageDiv.classList.add('new-message');
                setTimeout(() => messageDiv.classList.remove('new-message'), 500);
            }

            formatMessage(text) {
                return text.replace(/\n/g, '<br>');
            }

            handlePhotoUpload(files) {
                if (this.userPhotos.length + files.length > 5) {
                    alert('–ú–∞–∫—Å–∏–º—É–º 5 —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π!');
                    return;
                }

                Array.from(files).forEach(file => {
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            this.userPhotos.push({
                                id: Date.now() + Math.random(),
                                data: e.target.result,
                                timestamp: new Date().toISOString()
                            });
                            this.updatePhotoPreview();
                            this.saveUserData();
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }

            updatePhotoPreview() {
                const preview = document.getElementById('photoPreview');
                preview.innerHTML = '';

                this.userPhotos.forEach((photo, index) => {
                    const imgContainer = document.createElement('div');
                    imgContainer.className = 'photo-item';
                    imgContainer.innerHTML = `
                        <img src="${photo.data}" alt="–§–æ—Ç–æ ${index + 1}" onclick="window.datingChat.showFullPhoto('${photo.data}')">
                        <button class="delete-photo" onclick="window.datingChat.deletePhoto(${index})">√ó</button>
                    `;
                    preview.appendChild(imgContainer);
                });

                if (this.userPhotos.length > 0) {
                    document.getElementById('userAvatar').src = this.userPhotos[0].data;
                } else {
                    document.getElementById('userAvatar').src = '';
                }
            }

            deletePhoto(index) {
                this.userPhotos.splice(index, 1);
                this.updatePhotoPreview();
                this.saveUserData();
            }

            showFullPhoto(photoData) {
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.9);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 1000;
                    cursor: pointer;
                `;
                
                const img = document.createElement('img');
                img.src = photoData;
                img.style.cssText = `
                    max-width: 90%;
                    max-height: 90%;
                    border-radius: 10px;
                    box-shadow: 0 0 30px rgba(79, 195, 247, 0.5);
                `;

                modal.appendChild(img);
                modal.onclick = () => document.body.removeChild(modal);
                document.body.appendChild(modal);
            }

            simulateOtherUsers() {
                const fakeUsers = [
                    { name: '–ö–æ—Å–º–∏—á–µ—Å–∫–∏–π —Å—Ç—Ä–∞–Ω–Ω–∏–∫', id: 'user1' },
                    { name: '–õ—É–Ω–Ω–∞—è –ø—Ä–∏–Ω—Ü–µ—Å—Å–∞', id: 'user2' },
                    { name: '–ó–≤–µ–∑–¥–Ω—ã–π –≤–æ–∏–Ω', id: 'user3' }
                ];

                fakeUsers.forEach(user => {
                    this.participants.set(user.id, user);
                    this.addParticipant(user.name, user.id);
                });

                document.getElementById('onlineCount').textContent = this.participants.size + 1;
            }

            addParticipant(name, id) {
                const participantsList = document.getElementById('participantsList');
                const participantDiv = document.createElement('div');
                participantDiv.className = 'participant';
                participantDiv.id = `participant-${id}`;

                participantDiv.innerHTML = `
                    <div class="participant-avatar">${name.charAt(0)}</div>
                    <div class="participant-info">
                        <div class="participant-name">${name}</div>
                        <div class="participant-status online">online</div>
                    </div>
                `;

                participantsList.appendChild(participantDiv);
            }

            toggleEmojiPicker() {
                this.emojiPickerVisible = !this.emojiPickerVisible;
                const emojiGrid = document.getElementById('emojiGrid');
                
                if (this.emojiPickerVisible) {
                    emojiGrid.classList.add('show');
                } else {
                    emojiGrid.classList.remove('show');
                }
            }

            hideEmojiPicker() {
                this.emojiPickerVisible = false;
                document.getElementById('emojiGrid').classList.remove('show');
            }

            addEmoji(emoji) {
                const input = document.getElementById('messageInput');
                input.value += emoji;
                input.focus();
                this.hideEmojiPicker();
            }

            createStars() {
                this.createStarLayer('stars', 200, 3);
                this.createStarLayer('stars2', 100, 2);
                this.createStarLayer('stars3', 50, 1);
            }

            createStarLayer(layerId, count, size) {
                const layer = document.getElementById(layerId);
                for (let i = 0; i < count; i++) {
                    const star = document.createElement('div');
                    star.style.cssText = `
                        position: absolute;
                        width: ${size}px;
                        height: ${size}px;
                        background: white;
                        border-radius: 50%;
                        top: ${Math.random() * 100}%;
                        left: ${Math.random() * 100}%;
                        animation: twinkle ${2 + Math.random() * 3}s infinite;
                        animation-delay: ${Math.random() * 5}s;
                    `;
                    layer.appendChild(star);
                }
            }

            saveUserData() {
                const userData = {
                    photos: this.userPhotos,
                    lastUpdated: new Date().toISOString()
                };
                localStorage.setItem('cosmicDatingUserData', JSON.stringify(userData));
            }

            loadAllData() {
                this.loadUserData();
            }

            loadUserData() {
                try {
                    const saved = localStorage.getItem('cosmicDatingUserData');
                    if (saved) {
                        const userData = JSON.parse(saved);
                        this.userPhotos = userData.photos || [];
                        this.updatePhotoPreview();
                    }
                } catch (error) {
                    console.log('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
                }
            }

            clearAllData() {
                if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ?')) {
                    localStorage.removeItem('cosmicDatingUserData');
                    location.reload();
                }
            }
        }

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≤—ã–∑–æ–≤–∞ –∏–∑ HTML
        function toggleEmojiPicker() {
            window.datingChat.toggleEmojiPicker();
        }

        function addEmoji(emoji) {
            window.datingChat.addEmoji(emoji);
        }

        function sendMessage() {
            window.datingChat.sendMessage();
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', () => {
            window.datingChat = new DatingChat();
            
            // –ö–Ω–æ–ø–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
            const clearBtn = document.createElement('button');
            clearBtn.textContent = 'üßπ –û—á–∏—Å—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–µ';
            clearBtn.style.cssText = `
                position: fixed;
                bottom: 10px;
                right: 10px;
                background: rgba(255,0,0,0.3);
                color: white;
                border: none;
                padding: 5px 10px;
                border-radius: 5px;
                cursor: pointer;
                z-index: 1000;
                font-size: 12px;
            `;
            clearBtn.onclick = () => window.datingChat.clearAllData();
            document.body.appendChild(clearBtn);
        });
    </script>
</body>
</html>
